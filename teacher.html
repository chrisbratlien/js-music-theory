<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="jquery-latest.js"></script>
<link media="screen" href="testsuite.css" type="text/css" rel="stylesheet">
<link media="screen,print" href="fretboard.css" type="text/css" rel="stylesheet">
<link media="screen,print" href="teacher.css" type="text/css" rel="stylesheet">
<link media="print" href="fretboard-print.css" type="text/css" rel="stylesheet">
<script type="text/javascript" src="farbtastic.js"></script>
<link rel="stylesheet" href="farbtastic.css" type="text/css" />
<!--<script src="testrunner.js"></script>-->
<script src="array.js"></script>
<script src="color.js"></script>
<script src="js-music-theory.js"></script>

<script type="text/javascript">


var GuitarString = function(spec) {
  var foo = ['flat7','7','1','flat2','2','flat3','3','4','flat5','5','sharp5','6'];

  var that = {};
  that.number = spec.number || false;
  that.rootNote = spec.rootNote;
  that.frettedDegrees = spec.frettedDegrees;
  that.guitar = spec.guitar;

  //console.log(spec.frettedDegrees);
  that.frets = [];


  that.frettedFrets = function() {
    return that.frets.select(function(f) { return f.fretted; });
  };
  
  that.litFrets = function() {
    return that.frets.select(function(f) { return f.lit; });
  };
  
  that.unlitFrets = function() {
    return that.frets.select(function(f) { return ! f.lit; });
  };
  
  that.litFrettedFrets = function() {
    return that.frettedFrets().select(function(f) { return f.lit; });
  };

  that.unlitFrettedFrets = function() {
    return that.frettedFrets().select(function(f) { return ! f.lit; });
  };





  that.renderOn = function(html) {
    var div = document.createElement('div');
    $(div).addClass('string');
    $(div).addClass('string-number-' + that.number);
    $(html).append(div);
    for (var i = 0, l = that.frets.length; i < l; i += 1) {
      that.frets[i].renderOn(div);
    }
    
    var clearMe = document.createElement('div');
    $(clearMe).addClass('clear');
    $(html).append(clearMe);
    
  };

  var starter = [0,7,3,10,5,0];
  var foo = ['flat7','7','1','flat2','2','flat3','3','4','flat5','5','sharp5','6'];

  for(var i = 0; i < JSMT.MAXFRETS; i++){   
    var deg = foo[(that.rootNote+i)%12];
     
    that.frets.push(Fret({
      number: i,
      value: that.rootNote + i,
      fretted: function() { return that.frettedDegrees.indexOf(deg) > -1; }(),
      degree: deg,
      string: that
    }));  
  }
  JSMT.strings.push(that);
  
  return that;
}



var Guitar = function(spec) {
  var container = false;
  
  var foo = ['flat7','7','1','flat2','2','flat3','3','4','flat5','5','sharp5','6'];
   //var foo = ['f7',7,1,'f2',2,'f3',3,4,'f5',5,'s5',6];
  var starter = [0,7,3,10,5,0];
  
  

  var that = {};
  that.degreeList = spec.degreeList || '';
  that.strings = [];

  that.firstGrip = Grip({});


  that.harmonizeFirstGrip = function() {
    var bail = 100;
    ///that.reset();
    
    var session = JSMT.HarmonizeSession();


    
    var cidx = 0;
    var grip = that.firstGrip;////.nextGrip(); //the user has already done the first one!

    while (grip.hasFrets() && bail > 0) {
      ///console.log(grip.frets);
      if (grip.unlit() || grip == that.firstGrip) {
      
        ////console.log(grip.shape());
        var shape = grip.shape();
        
        ///console.log('shape',shape);
        
        
        session.addShape(shape);

        var color = session.getColorForShape(shape);
        //console.log('color',color);
        grip.lightUpWithHarmonics(color);
        cidx +=1;
      }
      bail -= 1;
      grip = grip.nextGrip();
    }
    that.firstGrip = Grip({});    //reset
  };

  that.goLong = function(orig) {
    result = orig;
    result = result.replace(/b/g,'flat');
    result = result.replace(/#/g,'sharp');
    
    //result = result.replace(/&#x266d;/g,'flat');
    //result = result.replace(/&#x266f;/g,'sharp');
    return result;
  }


  that.parseDegrees = function(degreeStr) {
    //console.log(degreeStr);
    degreeStr = that.goLong(degreeStr);
    //console.log(degreeStr);
    d2 = degreeStr.split(',');
    /////console.log(d2);
    //var degrees = eval('[' + degreeStr + ']');
    return d2;
  };

  that.renderOn = function(html) {
    ///console.log('renderOn list',that.degreeList);
    that.container = html;


    var harmonizeButton = jQuery('<button>Harmonize This!</button>');
    var clearButton = jQuery('<button>Clear</button>');



    var includeDegrees = document.createElement('input');
    includeDegrees.value = that.degreeList;
    $(includeDegrees).addClass('includeDegrees');
    $(includeDegrees).blur(function(e) { 
      //console.log(that.degreeList);
      ///console.log('blur',this.value);
      that.degreeList = this.value;
      that.redraw(); 
    });
    $(html).append(includeDegrees);
    $(html).append(harmonizeButton);
    harmonizeButton.click(function() {
      that.harmonizeFirstGrip();
    });


    $(html).append(clearButton);
    clearButton.click(function() {
      that.redraw();
      that.firstGrip = Grip({});
    });
    
    var div = document.createElement('div');
    $(div).addClass('guitar');
    $(html).append(div);

    for (var i = 0, l = that.strings.length; i < l; i += 1) {
      that.strings[i].renderOn(div);
    }
  };

  that.redraw = function() {
    ////console.log('redraw list',that.degreeList);  
    $(that.container).empty();
    that.strings = that.buildStrings();
    that.renderOn(that.container);
  };
  
  that.reset = function() {
    that.strings.each(function(s) {
      s.litFrets().each(function(f) {
        f.dim();
      });
    });
  
  };
  
  
  that.buildStrings = function() {
    var result = [];
    for (var i = 0, l = starter.length; i < l; i += 1) {
      var string = GuitarString({
        number: i+1,
        rootNote: starter[i],
        frettedDegrees: that.parseDegrees(that.degreeList),
        guitar: that
      });
      result.push(string);    
    }
    
    return result;
  };
  
  that.strings = that.buildStrings();

  return that; 
};






function rotateBackgroundColor(elem) {
  jElem = $(elem);
  ////console.log(jElem.css('background'));
  jElem.css('background',$('#color').val());
}

function build_guitar_table(fretboardID,strings,degrees) {
  //console.log('degrees:',degrees);
    
  var fretboardDiv = document.createElement('div');
  fretboardDiv.id = fretboardID;
  $(fretboardDiv).addClass('fretboard');
  $('#main').append(fretboardDiv);


  var includeDegrees = document.createElement('input');
  includeDegrees.value = degrees;
  includeDegrees.id = 'include_degrees-' + fretboardID.replace(/fretboard-/,'');
  /////console.log(includeDegrees.id);
  $(includeDegrees).addClass('includeDegrees');

  $(includeDegrees).blur(function(e) {update_guitar(fretboardID,parse_degrees(this.value));});

  $(fretboardDiv).append(includeDegrees);
  
  var table = document.createElement('table');
  //$(table).attr('cellpadding','0');
  $(table).attr('cellspacing','1');
  $(fretboardDiv).append(table);
  for (i = 0; i < strings.length; i++) {
    var tr = document.createElement('tr');
    $(tr).addClass('string');
    $(tr).addClass('string-' + i);
    for(j = 0; j < 30; j++) {
      var td = document.createElement('td');
      $(tr).append(td);
      $(td).addClass('fret');
      $(td).addClass('fret-' + j);
      var sf = 's' + i.toString() + 'f' + j.toString();
      $(td).addClass(sf);
      var className = 'degree-' + strings[i][j];
      $(td).addClass(className);
      ////console.log(className);
      $(td).click(function() {
          var defaultColor = this.style.backgroundColor;
          console.log(this);
          console.log(this.style.backgroundColor)
          rotateBackgroundColor(this);
        //$('#' + fretboardID + ' .' + sf).css('background','#fa0000');
      });
    }
    $(table).append(tr);
  }
  update_guitar(fretboardID,parse_degrees(degrees));
  //console.log('afterwards');
}

function build_guitar() {

  var strings = Array(
    build_string(0),
    build_string(1),
    build_string(2),
    build_string(3),
    build_string(4),
    build_string(5)
    );
return strings;  
}


$(document).ready(function(){

  //var degreeStr = $('#include_degrees-' + id).val();
  //zz id = fretboardID.replace(/fretboard-/,'');
  ////var degrees = include_degrees(id);
  //console.log(scalesByDegree.length);

  var scalesByDegree = [
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7',
    '1,2,3,4,5,6,7'
  ];
  
  $('#picker').farbtastic('#color');

  for (var i = 0, l = scalesByDegree.length; i < l; i += 1) {
    var d = document.createElement('div');
    $('#main').append(d);
    var guitar = Guitar({degreeList: scalesByDegree[i]});
    JSMT.guitars.push(guitar);
    guitar.renderOn(d);
  }


/*

  jQuery.each(scalesByDegree,function(i,e) {
    //console.log('i:',i);
  ///console.log('sbd',scalesByDegree[i]);
    var sbd = scalesByDegree[i]; //not sure why i need a var for this.
    build_guitar_table('fretboard-' + i,build_guitar(),sbd);
  //console.log(input_i.val());
  //////update_guitar('fretboard-' + i,parse_degrees(tmp.val()));    
  });
*/

});

 </script>
</head>
<body id="css-zen-garden">
  <div id="container">
    <div id="intro">
      <h1>Playing the Guitar in 20 Questions</h1>      
    </div>
    <div id="supportingText">
      <div class="form-item">
        <label for="color">Color:</label>
        <input type="text" id="color" name="color" value="#ff0f18" />
      </div>
      <div id="picker"></div>      
      <div id="main">


        <ol>
          <li>1. (optional) Pick a color</li>
          <li>2. Click some numbered frets to define your first chord</li>
          <li>3. Click Harmonize This! to see your chord harmonized across the major scale</li>
        </ol>

      
      </div>
    </div>
  </div>
<!--
<h1>E-Prime JavaScript Tests</h1>
<h2 id="banner"></h2>
<h2 id="userAgent"></h2>
<ol id="tests"></ol>
<div id="main"></div>
-->

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-4321414-2");
pageTracker._trackPageview();
</script>

</body>
</html>
