<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" nomanifest="js-music-theory.manifest">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
<title>Two Five</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">

<link media="screen" href="css/testsuite.css" type="text/css" rel="stylesheet">
<link media="screen,print" href="css/fretboard.css" type="text/css" rel="stylesheet">
<link media="print" href="css/fretboard-print.css" type="text/css" rel="stylesheet">


<link media="screen,print" href="css/teacher.css" type="text/css" rel="stylesheet">

<script src="http://cdn.dev.bratliensoftware.com/javascript/array.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/bsd.pubsub.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/color.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/dom.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/draggy.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/sticky-note.js"></script>


<!-- may try out some variations on eachify -->
<script src="javascript/eachify.js"></script>


<script src="javascript/bootup.js"></script>
<script src="javascript/js-music-theory.js"></script>
<script src="javascript/bsd.widgets.baseplayer.js"></script>
<script src="javascript/bsd.widgets.stringoscillator.js"></script>
<script src="javascript/bsd.widgets.guitarplayer.js"></script>
<script type="text/javascript" src="javascript/bsd.widgets.procrastinator.js"></script>



<script src="javascript/guitar.js"></script>

<style type="text/css">
.slider-wrap { 
  display:inline; 
  float: left; 
  margin: 15px; 
  height: 220px;
}

.slider-wrap .slider {
  height: 100%;

}

#quiz-output .note { font-size: 3em; }



.ruler {
  float: left; 
  padding: 0; 
  margin: 0; 
  width: 8%;
  cursor: pointer; 
}

.ruler .title { 
  text-align: center; 
  font-size: 1rem; 
  line-height: 1.55rem;
 }


.ruler .cell {  
  height: 50px; 
  line-height: 50px; 
  font-size: 50px;
  padding: 3px; 
  text-align: center; 
  color: #bbb;
}
.ruler .active { background: #33b; color: white; }






/* iphone 5 in portrait */
@media only screen 
and (min-device-width : 320px) 
and (max-device-width : 568px) 
and (orientation : portrait) { /* STYLES GO HERE */

  

}



/* ipad in portrait or landscape */
@media only screen 
/** and (min-device-width : 768px) ***/
/*** and (max-device-width : 1024px){ ***/   /* STYLES GO HERE */
and (min-width : 768px) {


  .ruler .cell {  
    height: 20px; 
    line-height: 20px; 
    font-size: 20px; 
  }


}





/* desktop and laptop */
@media only screen and (min-width : 1224px) {


  .ruler .cell {  
    height: 10px; 
    line-height: 10px; 
    font-size: 10px; 
  }

}






</style>
</head>
<body id="css-zen-garden">
  <div id="container">
    <div id="supportingText">
      <button id="more-palettes">Redraw Palettes</button>
      <div id="pickers">   </div><!-- pickers -->


        <div class="slider-wrap">
          Volume: <br /><span id="volume-amount"></span>
          <div class="slider" id="volume-input"></div>
        </div>
        <div class="slider-wrap">
            Detune:<br /> <span id="detune-amount"></span>
          <div class="slider" id="detune-input"></div>
        </div>
        <div style="clear: both;">&nbsp;</div>        
      <div id="main">
      </div>
      <button id="redo">Redo</button>
      
      <label>Progression <br />
        <input id="progression" />
      </label>
      
      
    </div>
  </div>
  
<script type="text/javascript">


var campfire = BSD.PubSub({});

if (typeof BSD == "undefined") {
  var BSD = {};    
}
BSD.chosenColor = BSD.colorFromHex('#888888');
BSD.ColorPicker = function(spec) {
  var self = {};
  self.renderOn = function(html) {
///console.log('hello');
    var square = DOM.div('').addClass('color-picker');
    square.css('background-color','#' + spec.color.toHex());
    square.click(function() {
      BSD.chosenColor = spec.color;
    });
////console.log('html',html);
    html.append(square);
  };
  return self;
};


  context = new webkitAudioContext();
  BSD.audioContext = context;
  
  
  
//ios trick
var unlocked = false;
window.addEventListener('touchstart', function() {
  if (unlocked) return false;
  unlocked = true;
  ///alert('unlocked');
	// create empty buffer
	var buffer = myContext.createBuffer(1, 1, 22050);
	var source = myContext.createBufferSource();
	source.buffer = buffer;

	// connect to output (your speakers)
	source.connect(context.destination);

	// play the file
	source.noteOn(0);

}, false);
  
  
  
  
  
  
  
  BSD.currentFretDiv = false;
  
  var pickers = jQuery('#pickers');
  
  var morePalettes = jQuery('#more-palettes');
  
  var palettes = [];
  
  


  
  
  campfire.subscribe('redraw-palettes',function(){
    pickers.empty();
    palettes = [];
    palettes.push(BSD.colorFromHex('000000').upTo(BSD.colorFromHex('FFFFFF'),20));
    palettes.push(BSD.randomPalette2(10,60));
    palettes.push(BSD.randomPalette2(10,60));
    palettes.push(BSD.randomPalette2(10,60));
    palettes.push(BSD.randomPalette2(10,50));
    palettes.push(BSD.randomPalette2(10,40));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.push(BSD.randomPalette2(10,30));
    palettes.each(function(pal) {
      pal.each(function(randcolor) { 
      var picker = BSD.ColorPicker({ color: randcolor});
      picker.renderOn(pickers);
      });
    });
  });
  
  morePalettes.click(function(){
    campfire.publish('redraw-palettes');
  });
  campfire.publish('redraw-palettes');






  BSD.parseProgression = function(progString) {
    var barStrings = progString.split('|');
    
    var barIndex = 0;
    var chordIndex = 0;
    var flat = [];
    
    barStrings.each(function(barString){
      var chordNames = barString.split(/,|\ +/);
      var halfBar = false;
      if (chordNames.length == 2) {
        halfBar = true;
      }
      
      
      
      chordNames.each(function(o){
        var origChord = makeChord(o);        
        var lowerChord = origChord.plus(-12);  
        
        flat.push({
          barIndex: barIndex,
          chordIndex: chordIndex,
          chord: lowerChord,
          halfBar: halfBar
        });
        chordIndex += 1;        
      });
      barIndex += 1;
    });

    return flat;
    ///wait
    var result = eachify(flat);
    console.log('result',result);
    return result;
  };
  


  
  

  //var degreeStr = $('#include_degrees-' + id).val();
  //zz id = fretboardID.replace(/fretboard-/,'');
  ////var degrees = include_degrees(id);
  //console.log(scalesByDegree.length);
  
   ///}
      
    BSD.audioPlayer = BSD.Widgets.GuitarPlayer({
      ////gossip: campfire,
      context: context,
      ////name: 'Piano',//chosen, //'Piano',
      polyphonyCount: 48,//polyphonyCount,
      range: [-300,128]
    });
      
    
    
    var waiter = BSD.Widgets.Procrastinator({ timeout: 250 });

    $( "#volume-input" ).slider({
      orientation: "vertical",
      range: "min",
      min: 0,
      max: 0.1,
      step: 0.01,
      value: 0.01,
      slide: function( event, ui ) {
        var newVolume = ui.value;
        waiter.beg(BSD.audioPlayer,'set-master-volume',ui.value);
        ////waiter.beg(BSD.chunker,'set-master-volume',ui.value);
        jQuery( "#volume-amount" ).text( newVolume );
      }
    });




    $( "#detune-input" ).slider({
      orientation: "vertical",
      range: "min",
      min: -7.0,
      max: 7.0,
      step: 0.25,
      value: 0.0,
      slide: function( event, ui ) {
        var n = ui.value;
        
        waiter.beg(BSD.audioPlayer,'set-detune-semis',n);        
        //////campfire.publish('set-speed-ms',n);
        jQuery( "#detune-amount" ).text( n );
      }
    });
    
    var volumeInput = jQuery('#volume-input');
    volumeInput.change(function(){
        BSD.audioPlayer.publish('set-master-volume',volumeInput.val());    
    });
    
    BSD.audioPlayer.publish('set-master-volume',0.01);

  jQuery(document).on('keydown',function(e) {
    var c = e.keyCode || e.which;
    
    if (BSD.currentNote && c == BSD.keycodes.f) {
      BSD.audioPlayer.playNote(BSD.currentNote,1000);    
    }
          
  });

function getRandomArbitrary(min, max) {
    return Math.random() * (max - min) + min;
}


  
  
  var main = jQuery('#main');

  var flavors = ['-7','7','6','-7b5','7b9','M7','13','7#9'];
  var flav = flavors.atRandom();


    var flavorMap = {
      '6': ['6','M7'],
      '-7': ['7','7b9'],
      '-7b5': ['7b9','7'],
      '7b9': ['M7','-7','-7b5'],
      '7': ['-7','M7','6','7'],
      'M7': ['M7','-7']
    };

  ////var currentRootNote = JSMT.twelveNotes().atRandom();
  var randColor = BSD.randomDarkColor(); ////palettes.atRandom().atRandom();


  campfire.subscribe('repaint-wrap',function(payload) {


    JSMT.allMIDIValues.select(function(o) {
      return o >= 40 && o <= 70;
    }).reverse().each(function(n){
      var cell = DOM.div().addClass('cell');
      var note = Note(n);
      cell.append(note.utf8Name());
      if (payload.chord.containsNote(note)) {
        cell.css('background','#' + randColor.toHex());
        cell.on('mouseout	mouseenter touchmove mouseover touchend',function(e){
          ////console.log('hover',note);
          //console.log('e',e);
          if (e.shiftKey) { return false; }
          BSD.audioPlayer.playNote(note,1000);
        });
        cell.addClass('active');  
      }
      payload.wrap.append(cell);
    });
    ////console.log(currentRootNote.name());  
  });


  campfire.subscribe('do-it',function(chords){

    randColor = BSD.randomDarkColor(); ////palettes.atRandom().atRandom();
    main.empty();

    chords.each(function(chord){  
      
      var alternates = flavors.map(function(txt){
        var c = chord.rootNote.chord(txt);
        return c;
      });
      
      eachify(alternates).eachPCN(function(o){
        o.current.next = o.next;
        o.current.prev = o.prev;
      });
      
      /////console.log('alternates',alternates);
      
      
      chord = alternates.detect(function(alt){
        return alt.abstractlyEqualTo(chord);
      }); //upgrade chord to itself in the alternates
      
      
      var ul = DOM.div().addClass('ruler');

      var title = DOM.div().addClass('title');
      var wrap = DOM.div().addClass('wrap');
      
      title.html(chord.utf8FullAbbrev());
      title.on('click',function(){
        chord = chord.next;
        title.html(chord.utf8FullAbbrev());
        wrap.empty();
        campfire.publish('repaint-wrap',{ wrap: wrap, chord: chord });
      });
      campfire.publish('repaint-wrap',{ wrap: wrap, chord: chord });
      
      
      ul.append(title);  
      ul.append(wrap);
      
      main.append(ul);
      
    });
  });

  jQuery('#redo').click(function(){
    var myChords = [];
    var current = JSMT.twelveNotes().atRandom();
    for (var i = 0; i < 12; i += 1) {
      var chord = current.chord(flav);
      myChords.push(chord);
      current = current.fourth();
      flav = flavorMap[flav].atRandom();
    }
    console.log('myChords',myChords);////.map(function(o){ return o.utf8FullAbbrev(); }));
    ///return false;

    //////currentRootNote = 

    campfire.publish('do-it',myChords);
  });
  campfire.publish('do-it',[]);


  var progInput = jQuery('#progression');
  progInput.blur(function() { 
    if (progInput.val().length == 0) { return false; }
    var prog = BSD.parseProgression(this.value);
    console.log('prog',prog);
    
    var myChords = prog.map(function(o){  return o.chord; });
    campfire.publish('do-it',myChords);
  });



</script>  
</body>
</html>
