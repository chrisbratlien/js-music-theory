<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" nomanifest="js-music-theory.manifest">
<head>
<script src="http://cdn.dev.bratliensoftware.com/javascript/array.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/color.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

<script src="http://cdn.dev.bratliensoftware.com/javascript/dom.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/draggy.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/sticky-note.js"></script>
<script src="javascript/js-music-theory.js"></script>
<script src="javascript/bsd.widgets.spinner.js"></script>
<script src="javascript/bsd.widgets.faker.js"></script>
<script src="javascript/bsd.widgets.player.js"></script>
<script src="javascript/sinewave.js"></script>

<!-- wavetable dependencies -->
<script src="javascript/bpm-delay.js"></script>
<script src="javascript/waveshaper.js"></script>
<script src="javascript/wavetable.js"></script>
<script src="javascript/fft.js"></script>
<script src="javascript/sequence.js"></script>
<script src="javascript/wtnote.js"></script>
<script src="javascript/wavetableloader.js"></script>
<script src="javascript/staticaudiorouting.js"></script>
<style type="text/css">


  .clear { clear: both; }

  .foo img { width: 100%; }
  input { width: 100%; }


  body { font-family: Helvetica, Arial; }

  #table1-wrap table tr{ border-bottom: 1px solid #aaa; }
  #table1-wrap table tr td{ padding: 3px; border-top: 1px solid #aaa; border-left: 1px solid #aaa; }


  #table1-wrap table tr.new-bar td{ border-top: 4px solid #904; border-bottom: none; }

  #table1-wrap table tr td { text-align: center; }
  #table1-wrap table tr td.chord-name { width: 60px; }

  #table1-wrap table tr td.cell { width: 25px; text-align: center; }



  #table1-wrap table tr td.on { background-color: #647; color: white; }



  #table1-wrap ul { list-style-type: none; }
  #table1-wrap ul li { float: left; margin-right: 1.5em; }


  #faker-wrap { width: 90%; margin: 0 auto; margin-top: 1em; }
  #faker-wrap .bar { width: 24%;  float: left; position: relative;}
  #faker-wrap .bar .chord { float: left; border: 1px solid white; width: 99%; }
  #faker-wrap .bar .chord.half { width: 49%; }
  #faker-wrap .bar .chord.third { width: 32%; }
  #faker-wrap .bar .chord.fourth { width: 24%; }

  #faker-wrap .bar ul { list-style-type: none; margin: 0; padding: 0; /* height: 85%; position: absolute; bottom: 0; */ }
  #faker-wrap .bar ul li { height: 0.9em; padding-left: 0.5em; }  
  #faker-wrap .cell { font-size: 0.4em; border-top: 1px solid #abc; padding: 1px; }
  #faker-wrap .on { background-color: #38f; color: white;  }
  #faker-wrap .scale.on { background-color: #edf; color: #98f;  }

  #faker-wrap .on.young { background-color: #9f9; color: #393;  }
  #faker-wrap .on.old { background-color: #f99; color: #933;  }
  #faker-wrap .on.young.old { background-color: #fc9; color: #963;  }

  #faker-wrap .legend div { float: left; padding: 5px; }


  .bsd-widgets-player { width: 50%;  }


  .bsd-widgets-player label { margin-right: 1em; }


  .bsd-widgets-player .fret, .bsd-widgets-player .fret-label { 
    /*
    width: 21px; 
    height: 14px; line-height: 14px; 
    */
    width: 4%;
    height: 2em; line-height: 2em;

    background: #eee; border-radius: 2px; 
    float: left; margin: 1px; text-align: center; 
    
  }
  
  .bsd-widgets-player .fret-label { font-size: 0.5em; }
  

  .bsd-widgets-player .legend .fret { width: 92px; }



  /* lowest priority in the cascade */
  .bsd-widgets-player .fret.compat-scale { background: #dcd; }
  .bsd-widgets-player .fret.compat-scale-root { background: #ace; }



  .bsd-widgets-player .fret { font-size: 0.5em; }
  .bsd-widgets-player .fret-1 { border-radius: none; border-left: 1px solid black; }

  #ignore .bsd-widgets-player .fret.prev { background: #bba; }
 /* .bsd-widgets-player .fret.next { background: #ccc; } */
  .bsd-widgets-player .fret.on { background: #fa0; color: #940; }
  .bsd-widgets-player .fret-0 { background: #fff; border-radius: none; border-right: 1px solid black; }
  .bsd-widgets-player .fret-0.on { background: #750; color: white; }


  .bsd-widgets-player .fret.color { color: white; }
  .bsd-widgets-player .fret.root { background: red; color: white; }

  .bsd-widgets-player .position-indicator { width: 200px; height: 200px; list-style-type: none;  }
  .bsd-widgets-player .position-indicator li { margin: 0; float: left; width: 25%; background: #aaf; color: #778; text-align: center;  }
  .bsd-widgets-player .position-indicator li.selected { background: yellow; }



  /* .bsd-widgets-player .fret.above { background: #ccd; } */


  .sticky-note {  position: absolute; top: 20px; left: 20px; cursor:  pointer; box-shadow: 3px 3px 13px #aaa; z-index: 100; }
  .sticky-note textarea { background: #ffa; cursor:  pointer; border: 1px solid #dd8; width: 20px; height: 20px; font-family: Georgia; }


</style>

<style type="text/css" media="print">
  body { font-size: 0.5em; }

</style>

</head>
<body>
<button id="sticky-note-button">Sticky Note</button>
<div id="stage"></div>
<br />





<div id="chord-player-wrap"></div>
<div id="faker-wrap">
</div>
<div id="table1-wrap"></div>
<div id="table2-wrap"></div>

<button id="sinewave">Play Sinewave</button>
<script type="text/javascript">


  function probablyTrue(prob) {
    var res = Math.random();
    return (res < prob); 
  }
  
  function prob(prob,funcTrue,funcFalse) {
    return probablyTrue(prob) ? funcTrue() : funcFalse();
  }



  function getChordImages(cb) {
    jQuery.ajax({ type: 'POST', url: 'ws.php', data: { action: 'chord_images' }, 
      success: function(r) { cb( eval( '(' + r + ')' )) } });
  }



  BSD.Widgets.Riffer = function(spec) {
  
    var self = {};
    var map = {};
    
    self.go = function(progression) {    

      var wrap1 = jQuery('#table1-wrap');

      var table1 = DOM.table().attr('cellpadding',0).attr('cellspacing',0);
      
      var headerRow = DOM.tr();
      
      headerRow.append(DOM.th('&nbsp;'));
      
      JSMT.twelveTones().each(function(t) {
        headerRow.append(DOM.th(t));
      });
      table1.append(headerRow);
      
      wrap1.append(table1);
      
      
      
      var newBar = false;
      
      var bars = progression.split('|');
      bars.each(function(bar) {
        newBar = true;
        var chordNames = bar.split(/,|\ +/);
        chordNames.each(function(name) {
        
        
        
          var chord = makeChord(name);      
          var row = DOM.tr();
          row.append(DOM.td(name).addClass('chord-name'));
          if (newBar) {
            newBar = false;
            row.addClass('new-bar');
          }
  
          JSMT.twelveNotes().each(function(n) {
            var cell = DOM.td(n.name());
            cell.addClass('cell');
            if (chord.containsNote(n)) {
              cell.addClass('on');
            }
            row.append(cell);
          });
          
          var ul = DOM.ul();
          var sorted = chord.compatibleScaleAbbrevs().sort(function(a,b) {
            var aRoot = a.substr(0,1).match(chord.rootNote.name());
            var aMajor = a.match(/major/);
            var bRoot = b.substr(0,1).match(chord.rootNote.name());
            var bMajor = b.match(/major/);
            var aRootAndMajor = aRoot && aMajor;
            var bRootAndMajor = bRoot && bMajor;
            
            if (aRootAndMajor && ! bRootAndMajor) { return -3; }
            if (aMajor && ! bMajor) { return -2; }
            if (aRoot && ! bRoot) { return -1; }


            if (bRootAndMajor && ! aRootAndMajor) { return 3; }
            if (bMajor && ! aMajor) { return 2; }
            if (bRoot && ! aRoot) { return 1; }

            return a < b; 
          
          });
          
          sorted.each(function(s) {
            var li = DOM.li(s);
            ul.append(li);
          });
          row.append(DOM.td(ul));
          table1.append(row);
        });
      });
    };        
    return self;
  };

  var chordPlayerWrap = jQuery('#chord-player-wrap');
  


  /* audio stuff */
  if (typeof webkitAudioContext != "undefined") {
    BSD.audioContext = new webkitAudioContext();
  }
  
  
  function midi2hertz(x) {
    return Math.pow(2,(x-69)/12)*440;
  }
  
  BSD.hzTable = [];
  var a = 440; // a is 440 hz...
  for (var x = 0; x <= 127; ++x)
  {
    BSD.hzTable[x] = midi2hertz(x);
  }
  
  
  function soundIt(freq,duration) {
    var sinewave = new SineWave(BSD.audioContext);
    sinewave.setFrequency(freq);
    sinewave.play();
    setTimeout(function() { sinewave.pause(); },duration);
  }
  
  
  BSD.MIDIPlayer = function(spec) {
    var self = {};

    self.playChord = function(chord,duration) {
      chord.notes().each(function(n) { self.playNote(n,duration); });
    };

    self.playNote = function(note,duration) {
      soundIt(BSD.hzTable[note.value()],duration);  
    };
    return self;
  };


function wtInit() {
        context = new webkitAudioContext();
        staticAudioRouting = new StaticAudioRouting();
        monophonicNote = new WTNote(staticAudioRouting, true);
    
        loadWaveTables();
        sequence = new Sequence();
}



/** wavetable experimentation **/
var loader;
var sequence;
var defaultWaveTableName = "Celeste"; ///"Twelve String Guitar 1"; //"Celeste";
var arp = true;
var playMonophonic = true;



var context;
context = new webkitAudioContext();

var staticAudioRouting;
staticAudioRouting = new StaticAudioRouting();


var waveTable;
var waveTable2;
var monophonicNote;

////
var cutoff = 0.2;
var resonance = 12;
var envAmount = 0.4;
var width = 0.6;
var detune1 = 4.5;
var detune2 = -2.5;
var octave = 0;


var volume = 1;
var filterAttack = 0.056;
var filterDecay = 0.991;
var ampAttack = 0.056;
var ampDecay = 0.100;
var playDoubleOctave = false;
var grungeDrive = 1;

var views;
var sequenceView;

var isShiftDown = false;
var isAltDown = false;

var tempo = 85.0;





wtInit(); //// <========== XXX





function start() {
    // first, get rid of loading animation
    //var loading = document.getElementById("loading");
    //loading.innerHTML = "";

    startTime = context.currentTime + 0.160;
    
    waveTable = loader.getTable(defaultWaveTableName);
    waveTable2 = loader.getTable(defaultWaveTableName);
    ///sequence.schedule();    
}


function loadWaveTables() {
    loader = new WaveTableLoader();
    loader.load(start);        
}


function loadImpulseResponse(url, convolver) {
    // Load impulse response asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    request.onload = function() { 
        convolver.buffer = context.createBuffer(request.response, false);
        isImpulseResponseLoaded = true;
    }
    request.onerror = function() { 
        alert("error loading reverb");
    }

    request.send();
}







BSD.wtTest = function() {

 
  var self = {};  
 
  function init() {
        context = new webkitAudioContext();
        staticAudioRouting = new StaticAudioRouting();
        monophonicNote = new WTNote(staticAudioRouting, true);
    
        loadWaveTables();
        
    
        sequence = new Sequence();
    
        ///addUI();
  }  
  
  
  self.go = function() {
    init();
  
  };
  
  
    return self;
  
  };



  BSD.OSCPlayer = function(spec) {

    var context = BSD.audioContext;
    var ctx = context;

    var self = {};

    var SINE = 0, SQUARE = 1, SAWTOOTH = 2, TRIANGLE = 3, CUSTOM = 4;


    var playing = {};
    
    var oscillators = [];
    self.oscillators = oscillators;
    
    [0,1,2,3,4,5,6,7,8].each(function(i) {
      var oscillator = ctx.createOscillator();
      oscillator.id = i; //FIXME: is this sane?
      playing[oscillator.id] = false;  
      oscillator.type = SINE;////[0,1,2,3].atRandom();
      oscillator.connect(context.destination);
      oscillators.push(oscillator);
    });


    var updateFreq = function(freq) {
        oscillator.type = parseInt($('#comboWaveType').val(),10) ;
        oscillator.frequency.value = freq;
        oscillator.connect(context.destination);
        oscillator.noteOn && oscillator.noteOn(0); // this method doesn't seem to exist, though it's in the docs?
        $("#freqDisplay").val(freq + "Hz");
    };
      
    self.idleOscillators = function() {
      //return oscillators.select(function(o) { return o.playbackState == 0; });
      return oscillators.select(function(o) { return playing[o.id] == false; });
    };
      
    self.hush = function() {
      oscillators.each(function(o) { o.disconnect(); });
    };


    self.playChord = function(chord,duration) {
      
      var tooDamnHigh = 50;
      var tooDamnLow = 30;
      
      var tooHigh = chord.notes().detect(function(n) { return n.value() > tooDamnHigh; });
      while (tooHigh) {
        ////console.log('tooDamnHigh',chord.fullName());
        chord = chord.invertDown();
        var tooHigh = chord.notes().detect(function(n) { return n.value() > tooDamnHigh; });
      }

      var tooLow = chord.notes().detect(function(n) { return n.value() < tooDamnLow; });      
      while (tooLow) {
        ////console.log('tooDamnLow',chord.fullName());
        chord = chord.invertUp();
        var tooLow = chord.notes().detect(function(n) { return n.value() < tooDamnLow; }); 
      }
            
      var midivalues = chord.notes().collect(function(n) { return n.value(); });
      console.log(midivalues);
      chord.notes().each(function(n) { self.playNote(n,duration); });
    };

    self.playNote = function(note,duration) {
      var o = self.idleOscillators().detect(function(o) { return true; });
      BSD.o = o;
      
      if (o == false) {
        console.log('no free oscs',note,duration);
        return false;
      }

      o.frequency.value = BSD.hzTable[note.value()];
      o.connect(ctx.destination);
      o.noteOn(0);
      
      playing[o.id] = true;
      
      setTimeout(function() { 
        o.disconnect(); 
        playing[o.id] = false;        
      },duration);
    
      /////self.soundIt(BSD.hzTable[note.value()],duration);  
    };
    return self;
  };
  
  
BSD.Oscar = function(spec) {

  var panner1 = context.createPanner();
  panner1.panningModel = webkitAudioPannerNode.EQUALPOWER;
  
  var panner2 = context.createPanner();
  panner2.panningModel = webkitAudioPannerNode.EQUALPOWER;
  

  // Amplitude envelope
  var ampEnvelope = context.createGainNode();
  ampEnvelope.gain.value = 0.0; // default value

  // Create note volume.
  var noteVolume = context.createGainNode();
  noteVolume.gain.value = 0; // start out silent until told otherwise



    // Filter
    var filter = context.createBiquadFilter();
    filter.type = 0;
    filter.gain.value = 0.0; // default value



  var isMonophonic = true;

    var osc1 = context.createBufferSource();
    osc1.looping = true;

    var osc1Octave = context.createBufferSource();
    osc1Octave.looping = true;

    var osc2 = context.createBufferSource();
    osc2.looping = true;

    var osc2Octave = context.createBufferSource();
    osc2Octave.looping = true;
        
    // oscillators --> panners.
    osc1.connect(panner1);
    osc1Octave.connect(panner1);
    osc2.connect(panner2);
    osc2Octave.connect(panner2);

    // panners --> amplitude envelope
    panner1.connect(ampEnvelope);
    panner2.connect(ampEnvelope);

    // amplitude envelope --> filter envelope
    ampEnvelope.connect(filter);

    // filter envelope --> note volume
    filter.connect(noteVolume);

    // note volume -> subsonic filter
    noteVolume.connect(staticAudioRouting.subsonicFilter /*subsonicFilter*/);
    
    
    

    osc1.noteOn(0);
    osc2.noteOn(0);
    osc1Octave.noteOn(0);
    osc2Octave.noteOn(0);

    var self = spec;
    self.osc1 = osc1;
    self.osc2 = osc2;
    self.osc1Octave = osc1Octave;
    self.osc2Octave = osc2Octave;
    self.playing = false;
    var o = self;


  self.setFilterValues = function() {
    var time = context.currentTime;

    var pitchFrequency = self.pitchFrequency;
    
    filter.frequency.cancelScheduledValues(0);

    filter.type = 0; // Lowpass
    filter.Q.value = resonance; // !!FIXME: should be Q

    var nyquist = 0.5 * context.sampleRate;

    var cutoffCents = 9600 * cutoff;
    var cutoffRate = Math.pow(2, cutoffCents / 1200.0);
    var startFrequency = cutoffRate * pitchFrequency;
    if (startFrequency > nyquist)
        startFrequency = nyquist;

    var envAmountCents = 7200 * envAmount;
    var envAmountRate = Math.pow(2, envAmountCents / 1200.0);
    var envAmountFrequency = startFrequency * envAmountRate;
    if (envAmountFrequency > nyquist)
        envAmountFrequency = nyquist;

    filter.frequency.setTargetValueAtTime(envAmountFrequency, time, filterAttack);
    filter.frequency.setTargetValueAtTime(startFrequency, time + filterAttack, filterDecay);
  };


  self.play = function(wave, wave2, semitone, octave, duration) {   
  
    console.log('playyy');
    self.playing = true;

    setTimeout(function() { self.playing = false; },duration);

    var time = context.currentTime;
        
    // Set oscillator pitches.
    
    var pitchFrequency = 20.0 /*440.0*/ * Math.pow(2.0, semitone / 12.0);
    self.pitchFrequency = pitchFrequency;
    
    
    var pitchRate = pitchFrequency * wave.getRateScale();

    var rate1 = pitchRate * Math.pow(2.0, -detune1/1200);
    var buffer1 = wave.getWaveDataForPitch(rate1);
    if (WTNote.firstTime) osc1.buffer = buffer1;

    osc1.playbackRate.value = rate1;


    var rate2 = pitchRate * Math.pow(2.0, octave - detune2/1200);
    var buffer2 = wave2.getWaveDataForPitch(rate2);
    if (WTNote.firstTime) osc1Octave.buffer = buffer2;
    osc1Octave.playbackRate.value = rate2;

    if (WTNote.firstTime) osc2.buffer = buffer1;
    osc2.playbackRate.value = pitchRate * Math.pow(2.0, +detune1/1200); // max one semi-tone

    if (WTNote.firstTime) osc2Octave.buffer = buffer2;
    osc2Octave.playbackRate.value = pitchRate * Math.pow(2.0, octave + detune2/1200); // max one semi-tone
    
    // Set panning amount for width spreading.
    
    // pan maximum from -90 -> +90 degrees
    var x = Math.sin(0.5*Math.PI * width);
    var z = -Math.cos(0.5*Math.PI * width);
    panner1.panningModel = webkitAudioPannerNode.EQUALPOWER;
    panner1.setPosition(-x, 0, z);

    panner2.panningModel = webkitAudioPannerNode.EQUALPOWER;
    panner2.setPosition(x, 0, z);

    // Amplitude envelope
    ampEnvelope.gain.cancelScheduledValues(0);

    
    // Amplitude attack
    var ampAttackTime = time + ampAttack;
    
    // Amplitude decay
    ampEnvelope.gain.setTargetValueAtTime(1, time, ampAttack);
    ampEnvelope.gain.setTargetValueAtTime(0, ampAttackTime, ampDecay);

    // Filter
    self.setFilterValues();

    // Set note volume.
    noteVolume.gain.value = 0.1 * volume*volume; // use x^2 volume curve for now

}



    return self;    
};


BSD.WTPlayer = function(spec) {


  var time = context.currentTime;
  var isMonophonic = true;

  var self = BSD.OSCPlayer(spec);

  self.idleOscillators = function() {
    return oscillators.select(function(o) { return o.playing == false; });
  };

  var oscillators = [];
  self.oscillators = oscillators;
  [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].each(function(i) {
    var oscillator = BSD.Oscar({ id: i  });  
    oscillators.push(oscillator);
  });

  self.play = function(wave, wave2, semitone, octave, duration) {   
    var o = self.idleOscillators().detect(function(o) { return true; });
    if (!o) { 
      console.log('could not find idle oscillator'); 
      return false; 
    }
    o.play(wave, wave2, semitone, octave, duration);
  };

  self.playNote = function(note,duration) {
    self.play(waveTable, waveTable2, note.value(), octave, duration);  
  };
  return self;
};

  
  function letsDoThis(prog) {
    riffer.go(prog);
    faker.go(prog);


    var chordPlayer = BSD.Widgets.ChordPlayer({ 
      progression: prog, 
      guid: 'CHORXDY',
      audioPlayer: audioPlayer 
    });
    chordPlayer.renderOn(chordPlayerWrap);
    chordPlayer.play();
    BSD.chordy = chordPlayer;
  }


  

  var stage = jQuery('#stage'); ///DOM.div().addClass('stage');


  var audioPlayer = BSD.WTPlayer(); ////////BSD.OSCPlayer({});
  var riffer = BSD.Widgets.Riffer({});
  var faker = BSD.Widgets.Faker({
    audioPlayer: audioPlayer 
  });
  BSD.audioPlayer = audioPlayer;
  
  

  var input = DOM.input().addClass('progression').attr('type','text');
  input.blur(function() {
    letsDoThis(input.val());
  });
  stage.append(input);


  
  var allOfMeButton = DOM.button('All of Me').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('All of Me'));
    var prog = 'CM7|CM7|E7|E7|A7|A7|D-7|D-7|E7|E7|A-7|A-7|D7|D7|D-7|G7|CM7|CM7|E7|E7|A7|A7|D-7|D-7|FM7|F-7|E-7|A7|D-7|G7|C6 D#o7|D-7 G7';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);

  });
  stage.append(allOfMeButton);


  var orpheusButton = DOM.button('Black Orpheus').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('Black Orpheus'));
    var prog = 'A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|A-7|D-7 G7|CM7|C#o7 A7b9|D-7|G7|C6|FM7|B-7b5|E7b9|A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|E-7b5|A7b9|D-7|D-7|D-7|B-7b5 E7b9|A-7|FM7|B-7b5|E7b9|A-7|B-7b5 E7b9';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);
  });
  stage.append(orpheusButton);

  var stLouisButton = DOM.button('St. Louis Blues').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('St. Louis Blues'));
    var prog = 'G-7|G-7|D7|D7|D7|D7|G-7|D7+9|G-7|G-7|D7|D7|D7|D7|G-7 A7|D7|G7|C7|G7|G7|C7|C7|G7|G7|D7|C7|G7|A-7 D7|G7|G7|G7|G7|C7|C7|G7|E7+9|A-7|D7|G7 Bb7|A-7 D7';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);
  });
  stage.append(stLouisButton);


  var stickyNoteButton = jQuery('#sticky-note-button');
  stickyNoteButton.click(function() {
    var sticky = BSD.Widgets.StickyNote();
    sticky.renderOn(jQuery(document.body));
  });


/*****

$(document).ready(function() {

    var context = new webkitAudioContext(),
        oscillator = context.createOscillator();

    var updateFreq = function(freq) {
        oscillator.type = parseInt($('#comboWaveType').val(),10) ;
        oscillator.frequency.value = freq;
        oscillator.connect(context.destination);
        oscillator.noteOn && oscillator.noteOn(0); // this method doesn't seem to exist, though it's in the docs?
        $("#freqDisplay").val(freq + "Hz");
    };
        
    $("#freqSlider").bind("change",function() {
        $("#freqDisplay").val( $("#freqSlider").val() + "Hz");
        updateFreq($("#freqSlider").val());
    });
        
    $("#btnPlay").click(function() {
        updateFreq($("#freqSlider").val());
    });

    $("#btnPause").click(function() {
        // stop frequency increase (if on)
        $("#btnSlowClimb").text("Slowly Increase Frequency");
        slowClimbIncr = -1;
        
        // kill sound
        oscillator.disconnect();
    });

    $("#comboWaveType").change(function() {
        updateFreq($("#freqSlider").val());
    });
    
    var slowClimbIncr = 0;
    $("#btnSlowClimb").toggle(function() {
        $("#btnSlowClimb").text("Stop Increase Frequency");
        slowClimbIncr = $("#freqSlider").val();
        
        var increase = function() {
            if (slowClimbIncr === -1 || slowClimbIncr > 22000) {return;}
            
            if ( slowClimbIncr !== 0 && slowClimbIncr !== ( parseInt($("#freqSlider").val(),10)+1) ) {
                slowClimbIncr = $("#freqSlider").val();
            }
            
            $("#freqSlider").val(slowClimbIncr);
            updateFreq(slowClimbIncr);
            slowClimbIncr++;
            setTimeout(increase, 50);
        };
        
        $("#freqSlider").val(slowClimbIncr);
        increase();
        
    }, function() {
        $("#btnSlowClimb").text("Slowly Increase Frequency");
        slowClimbIncr = -1;
    });
});

***/










  

</script>
</body>
</html>
