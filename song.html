<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" nomanifest="js-music-theory.manifest">
<head>
<script src="http://cdn.dev.bratliensoftware.com/javascript/array.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/color.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

<script src="http://cdn.dev.bratliensoftware.com/javascript/dom.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/draggy.js"></script>
<script src="http://cdn.dev.bratliensoftware.com/javascript/sticky-note.js"></script>
<script src="javascript/js-music-theory.js"></script>
<style type="text/css">


  .clear { clear: both; }

  .foo img { width: 100%; }
  input { width: 100%; }


  body { font-family: Helvetica, Arial; }

  #table1-wrap table tr{ border-bottom: 1px solid #aaa; }
  #table1-wrap table tr td{ padding: 3px; border-top: 1px solid #aaa; border-left: 1px solid #aaa; }


  #table1-wrap table tr.new-bar td{ border-top: 4px solid #904; border-bottom: none; }

  #table1-wrap table tr td { text-align: center; }
  #table1-wrap table tr td.chord-name { width: 60px; }

  #table1-wrap table tr td.cell { width: 25px; text-align: center; }



  #table1-wrap table tr td.on { background-color: #647; color: white; }



  #table1-wrap ul { list-style-type: none; }
  #table1-wrap ul li { float: left; margin-right: 1.5em; }


  #faker-wrap { width: 100%; margin: 0 auto; }




  #faker-wrap .bar { width: 24%; height: 308px; float: left; position: relative;}

  #faker-wrap .bar .chord { float: left; border: 1px solid #798; width: 99%; }
  #faker-wrap .bar .chord.half { width: 49%; }
  #faker-wrap .bar .chord.third { width: 32%; }
  #faker-wrap .bar .chord.fourth { width: 24%; }
  

  /* #faker-wrap .bar .chord .notes { width: 49%; } */


  #faker-wrap .bar ul { list-style-type: none; margin: 0; padding: 0; /* height: 85%; position: absolute; bottom: 0; */ }
  #faker-wrap .bar ul li { height: 0.9em; padding-left: 0.5em; }  
  #faker-wrap .bar .cell { font-size: 0.4em; border-top: 1px solid #abc; }
  #faker-wrap .bar .cell.on { background-color: #38f; color: white;  }
  #faker-wrap .bar .cell.scale.on { background-color: #98f; color: white;  }



  #player-wrap label { margin-right: 1em; }

  



  /* lowest priority in the cascade */
  #player-wrap .fret.compat-scale { background: #dcd; }



  #player-wrap .fret { width: 21px; height: 14px; background: #eee; border-radius: 2px; float: left; margin: 1px; text-align: center; line-height: 14px; }

  #player-wrap .legend .fret { width: 92px; }


  #player-wrap .fret { font-size: 0.5em; }
  #player-wrap .fret-1 { border-radius: none; border-left: 1px solid black; }

  #ignore #player-wrap .fret.prev { background: #bba; }
  #player-wrap .fret.next { background: #aab; }
  #player-wrap .fret.on { background: #fa0; color: #940; }
  #player-wrap .fret-0 { background: #fff; border-radius: none; border-right: 1px solid black; }
  #player-wrap .fret-0.on { background: #750; color: white; }


  #player-wrap .fret.above { background: #abd; }


  .sticky-note {  position: absolute; top: 20px; left: 20px; cursor:  pointer; box-shadow: 3px 3px 13px #aaa; z-index: 100; }
  .sticky-note textarea { background: #ffa; cursor:  pointer; border: 1px solid #dd8; width: 20px; height: 20px; font-family: Georgia; }


</style>

<style type="text/css" media="print">
  body { font-size: 0.5em; }

</style>

</head>
<body>
<button id="sticky-note-button">Sticky Note</button>
<div id="stage"></div>
<br />
<label> Width of bars
  <input id="bar-width" type="range" min="0" max="100" value="25" />
</label>


<label> Delay of player
  <input id="player-delay" type="range" min="0" max="5000" value="1000" />
</label>



<div id="player-wrap"></div>
<div id="faker-wrap"></div>
<div id="table1-wrap"></div>
<div id="table2-wrap"></div>
<script type="text/javascript">


  function probablyTrue(prob) {
    var res = Math.random();
    return (res < prob); 
  }
  
  function prob(prob,funcTrue,funcFalse) {
    return probablyTrue(prob) ? funcTrue() : funcFalse();
  }



  function getChordImages(cb) {
    jQuery.ajax({ type: 'POST', url: 'ws.php', data: { action: 'chord_images' }, 
      success: function(r) { cb( eval( '(' + r + ')' )) } });
  }



  BSD.Widgets.Riffer = function(spec) {
  
    var self = {};
    var map = {};
    
    self.go = function(progression) {    

      var wrap1 = jQuery('#table1-wrap');

      var table1 = DOM.table().attr('cellpadding',0).attr('cellspacing',0);
      
      var headerRow = DOM.tr();
      
      headerRow.append(DOM.th('&nbsp;'));
      
      JSMT.twelveTones().each(function(t) {
        headerRow.append(DOM.th(t));
      });
      table1.append(headerRow);
      
      wrap1.append(table1);
      
      
      
      var newBar = false;
      
      var bars = progression.split('|');
      bars.each(function(bar) {
        newBar = true;
        var chordNames = bar.split(/,|\ +/);
        chordNames.each(function(name) {
        
        
        
          var chord = makeChord(name);      
          var row = DOM.tr();
          row.append(DOM.td(name).addClass('chord-name'));
          if (newBar) {
            newBar = false;
            row.addClass('new-bar');
          }
  
          JSMT.twelveNotes().each(function(n) {
            var cell = DOM.td(n.name());
            cell.addClass('cell');
            if (chord.containsNote(n)) {
              cell.addClass('on');
            }
            row.append(cell);
          });
          
          var ul = DOM.ul();
          var sorted = chord.compatibleScaleAbbrevs().sort(function(a,b) {
            var aRoot = a.substr(0,1).match(chord.rootNote.name());
            var aMajor = a.match(/major/);
            var bRoot = b.substr(0,1).match(chord.rootNote.name());
            var bMajor = b.match(/major/);
            var aRootAndMajor = aRoot && aMajor;
            var bRootAndMajor = bRoot && bMajor;
            
            if (aRootAndMajor && ! bRootAndMajor) { return -3; }
            if (aMajor && ! bMajor) { return -2; }
            if (aRoot && ! bRoot) { return -1; }


            if (bRootAndMajor && ! aRootAndMajor) { return 3; }
            if (bMajor && ! aMajor) { return 2; }
            if (bRoot && ! aRoot) { return 1; }

            return a < b; 
          
          });
          
          sorted.each(function(s) {
            var li = DOM.li(s);
            ul.append(li);
          });
          row.append(DOM.td(ul));
          table1.append(row);
        });
      });
    };        
    return self;
  };
// all of me, part 1, CM7,CM7,E7,E7,A7,A7,D-7,D-7,E7,E7,A-7,A-7,D7,D7,D-7,G7



 BSD.Widgets.Spinner = function(spec) {
    var self = {};
    var length = spec.items.length;
    var callback = spec.callback || function(o) {};
    
    self.timeout = spec.timeout || 1000;

    var c,p,n = false;
    switch(length) {
      case 0:
        console.log('err-OR! does not compute. ');
        break;
      case 1:
        c = 0; n = 0; p = 0;
        break;
      case 2: 
        c = 0; n = 1; p = 1;
        break;
      default:
        c = 0; n = 1; p = length - 1;
        break;
    }
    
    self.spin = function() { 
      c += 1; c %= length;
      n += 1; n %= length;
      p += 1; p %= length;
      ////////console.log('c',c,'n',n,'p',p);
      
      callback({ prev: spec.items[p], current: spec.items[c], next: spec.items[n] });
      setTimeout(self.spin,self.timeout);
    };
    return self;
  };

/**
BSD.Widgets.Spinner({ 
  items: ["-","-","*"],
  timeout: 2000,
  callback: function(o) {
    var output = jQuery('#example1');
    output.append('<br />' + o.prev + ' ' + o.current + ' ' + o.next);      
  }
}).spin();
***/


  BSD.Widgets.Faker = function(spec) {
  
    var self = {};
    var map = {};
    
    self.go = function(progression) {    

      ////console.log("booo");
      var wrap = jQuery('#faker-wrap');
      var bars = progression.split('|');
      var last = false;
      bars.each(function(bar) {
        var barDiv = DOM.div().addClass('bar');        
        wrap.append(barDiv);
        var chordNames = bar.split(/,|\ +/);
        chordNames.each(function(name) {
          var chord = makeChord(name);
          var chordDiv = DOM.div().addClass('chord');
          if (chordNames.length == 2) {
            chordDiv.addClass('half');
          }
          if (chordNames.length == 3) {
            chordDiv.addClass('third');
          }
          if (chordNames.length == 4) {
            chordDiv.addClass('fourth');
          }
          
          barDiv.append(chordDiv);
          if (last == false) {
            chordDiv.append(DOM.h4(name));         
          }
          else if(chord.abstractlyEqualTo(last)) {
            chordDiv.append(DOM.h4('%'));
          }
          else {
            chordDiv.append(DOM.h4(name));        
          }

          //scale selector
          var sel = DOM.select();
          chordDiv.append(sel);
          chord.compatibleScales().each(function(scale) {
            var opt = DOM.option(scale.fullAbbrev());
            sel.append(opt);          
          });           


          var chordNotesDiv = DOM.div();
          chordNotesDiv.addClass('notes');
          chordNotesDiv.addClass('chord-notes');
          

          var scaleNotesDiv = DOM.div();
          scaleNotesDiv.addClass('notes');
          scaleNotesDiv.addClass('scale-notes');
          
          
          chordDiv.append(chordNotesDiv);
          chordDiv.append(scaleNotesDiv);

          var scaleUL = DOM.ul();
          scaleNotesDiv.append(scaleUL);

          var chordUL = DOM.ul();
          chordNotesDiv.append(chordUL);


          //show the chord notes
          JSMT.twelveNotes().reverse().each(function(n) {
            var cell = DOM.li(n.name());
            cell.addClass('cell');
            if (chord.containsNote(n)) {
              cell.addClass('on');
            }
            chordUL.append(cell);
          });

          var compatScales = chord.compatibleScales();
          if (compatScales.length > 0) {

            var scale = chord.compatibleScales().shift();  
            scaleUL.empty();
            JSMT.twelveNotes().reverse().each(function(n) {
              var cell = DOM.li(n.name());
              cell.addClass('cell');
              cell.addClass('scale');
              if (scale.containsNote(n)) {
                cell.addClass('on');
              } 
              scaleUL.append(cell);
            });

            sel.change(function() {            
              ///console.log('chord',chord);
            
              var scale = chord.compatibleScales().detect(function(s) { 
              //console.log(s.fullAbbrev(),'<->',sel.val());
              
              return s.fullAbbrev() == sel.val() });
              
              ///console.log('scale?',scale);
              
              scaleUL.empty();
              JSMT.twelveNotes().reverse().each(function(n) {
                var cell = DOM.li(n.name());
                cell.addClass('cell');
                cell.addClass('scale');
                if (scale.containsNote(n)) {
                  cell.addClass('on');
                } 
                scaleUL.append(cell);
              });
            });
          }
          
          //show the currently selected scale          
          
          last = chord;
        });
      });
      
      wrap.append(DOM.div().css('clear','both'));
    };        
    return self;
  };



  BSD.Widgets.Player = function(spec) {
    var self = {};

    var wrap = jQuery('#player-wrap');
    var board = DOM.div().addClass('fretboard');




    var chordLabel = DOM.h2();
    var noteLabel = DOM.label();
    var spinner = false;



    self.initFretboard = function() {
      wrap.empty();


      var legend = DOM.div().addClass('legend');
      legend.append(DOM.div('current').addClass('fret on current'));
      legend.append(DOM.div('next').addClass('fret next'));
      legend.append(DOM.div('above').addClass('fret above'));
      legend.append(DOM.div('scale').addClass('fret compat-scale'));
      legend.append(DOM.h5().addClass('clear'));
      legend.append(DOM.div().addClass('clear'));
      wrap.append(legend);


      wrap.append(board);

      wrap.append(chordLabel);
      wrap.append(noteLabel);
      var opens = [76,71,67,62,57,52];
      [0,1,2,3,4,5].each(function(stridx) {
        var stringDiv = DOM.div().addClass('string').addClass('string-' + stridx);
        [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].each(function(fidx) {
          var midinote = opens[stridx] + fidx;
          var noteName = Note(midinote).name();
          var nn = noteName.toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');          
          ////console.log(noteName);      
          
          var fretDiv = DOM.div().addClass('fret').addClass('fret-' + fidx).addClass('midinote-' + midinote).addClass('note-' + nn);         
          stringDiv.append(fretDiv);
        });
        board.append(stringDiv);
        board.append(DOM.div().addClass('clear'));
      });
    };    


    self.setDelay = function(ms) {
      spinner.timeout = ms;    
    };

    self.go = function(progression) {    
      self.initFretboard();
      
      var queue = [];
      
      var bars = progression.split('|');
      var last = false;
      bars.each(function(bar) {
        var barDiv = DOM.div().addClass('bar');        
        wrap.append(barDiv);
        var chordNames = bar.split(/,|\ +/);
        chordNames.each(function(name) {
          var chord = makeChord(name);
          
          var scales = chord.compatibleScales();
          
          chord.notes().each(function(note) {
            queue.push({ note: note, chord: chord, scales: scales });              
          });
        });
      });
      
      spinner = BSD.Widgets.Spinner({
        items: queue,
        timeout: 1000,
        callback: function(o) {
          var midinote = o.current.note.value();

          prevMIDI = o.prev.note.value();
          currentMIDI = o.current.note.value();
          nextMIDI = o.next.note.value();
          
          

          
          
          var scale = o.current.scales[0];
          ///console.log('scale',scale);
          
          var noteAboveNext = scale.noteAbove(o.next.note);
          var noteAboveNextName = noteAboveNext.name();
          var nann = noteAboveNextName.toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');          
          
          var prevName = Note(prevMIDI).name();
          var prevnn = prevName.toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');          
          var currentName = Note(currentMIDI).name();
          var currentnn = currentName.toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');          
          var nextName = Note(nextMIDI).name();
          var nextnn = nextName.toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');          



          //wrap.find('.midinote-' + prevMIDI).
          chordLabel.html(o.current.chord.fullAbbrev());
          noteLabel.html(o.current.note.name());
          
          board.find('.fret').removeClass('on');
          board.find('.fret').removeClass('current');
          board.find('.fret').removeClass('next');
          board.find('.fret').removeClass('prev');
/*
          board.find('.midinote-' + currentMIDI).addClass('on');
          board.find('.midinote-' + prevMIDI).addClass('prev');
          board.find('.midinote-' + nextMIDI).addClass('next');
*/
          board.find('.note-' + currentnn).addClass('on').addClass('current').html(currentName);
          board.find('.note-' + prevnn).addClass('prev').html(null);
          board.find('.note-' + nextnn).addClass('next');
          
          board.find('.above').removeClass('above');
          board.find('.note-' + nann).addClass('above');
          
          
          
          
          board.find('.compat-scale').removeClass('compat-scale');
          scale.notes().each(function(n) {
            var scalenn = n.name().toLowerCase().replace(/b/g,'flat').replace(/#/g,'sharp');  
            
            //console.log('scalenn',scalenn);
            board.find('.note-' + scalenn).addClass('compat-scale');
          });
          

        }
      });
      spinner.spin();
    };
    return self;
  };

  function letsDoThis(prog) {
    riffer.go(prog);
    faker.go(prog);
    player.go(prog);
  }


  var stage = jQuery('#stage'); ///DOM.div().addClass('stage');

  var riffer = BSD.Widgets.Riffer({});
  var faker = BSD.Widgets.Faker({});
  var player = BSD.Widgets.Player({});
  
  

  var input = DOM.input().addClass('progression').attr('type','text');
  input.blur(function() {
    letsDoThis(input.val());
  });
  stage.append(input);

  var range = jQuery('#bar-width');
  range.change(function(){
    jQuery('.bar').css('width',this.value + '%');
  });


  var playerDelay = jQuery('#player-delay');
  playerDelay.change(function(){
    player.setDelay(this.value);
  });
  playerDelay.val(1000);




  
  var allOfMeButton = DOM.button('All of Me').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('All of Me'));
    var prog = 'CM7|CM7|E7|E7|A7|A7|D-7|D-7|E7|E7|A-7|A-7|D7|D7|D-7|G7|CM7|CM7|E7|E7|A7|A7|D-7|D-7|FM7|F-7|E-7|A7|D-7|G7|C6 D#o7|D-7 G7';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);

  });
  stage.append(allOfMeButton);


  var orpheusButton = DOM.button('Black Orpheus').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('Black Orpheus'));
    var prog = 'A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|A-7|D-7 G7|CM7|C#o7|D-7|G7|C6|FM7|B-7b5|E7b9|A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|A-7|B-7b5 E7b9|E-7b5|A7b9|D-7|D-7|D-7|B-7b5 E7b9|A-7|FM7|B-7b5|E7b9|A-7|B-7b5 E7b9';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);
  });
  stage.append(orpheusButton);

  var stLouisButton = DOM.button('St. Louis Blues').click(function() {
    jQuery('#table1-wrap').empty();
    jQuery('#table1-wrap').append(DOM.h2('St. Louis Blues'));
    var prog = 'G-7|G-7|D7|D7|D7|D7|G-7|D7+9|G-7|G-7|D7|D7|D7|D7|G-7 A7|D7|G7|C7|G7|G7|C7|C7|G7|G7|D7|C7|G7|A-7 D7|G7|G7|G7|G7|C7|C7|G7|E7+9|A-7|D7|G7 Bb7|A-7 D7';
    jQuery('#faker-wrap').empty();
    input.val(prog);
    letsDoThis(prog);
  });
  stage.append(stLouisButton);


  var stickyNoteButton = jQuery('#sticky-note-button');
  stickyNoteButton.click(function() {
    var sticky = BSD.Widgets.StickyNote();
    sticky.renderOn(jQuery(document.body));
  });
  

  

</script>
</body>
</html>
